<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    * { margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: transparent; }
    canvas { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.10/browser/pixi.min.js"></script>
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>
  <script>
    const modelUrl = './model/IceGirl.model3.json';
    const app = new PIXI.Application({
      view: document.getElementById('canvas'),
      backgroundAlpha: 0,
      resizeTo: window,
      antialias: true,
    });

    let currentModel = null;
    let waving = false;

    function positionModel(model) {
      const scale = Math.min(app.screen.width / model.width, app.screen.height / model.height) * 0.8;
      model.scale.set(scale);
      model.anchor.set(0.5, 0.5);
      model.x = app.screen.width - (model.width * scale) / 2 - 300;
      model.y = app.screen.height / 2;
    }

    async function loadModel() {
      const model = await PIXI.live2d.Live2DModel.from(modelUrl, { autoInteract: false });
      app.stage.addChild(model);
      positionModel(model);

      model.interactive = true;
      model.buttonMode = true;
      model.on('pointerdown', () => {
        if (waving) return;
        waving = true;
        model.motion('Action', 0);
        setTimeout(async () => {
          app.stage.removeChild(model);
          model.destroy();
          currentModel = await reloadModel();
          waving = false;
        }, 7500);
      });

      return model;
    }

    async function reloadModel() {
      const model = await PIXI.live2d.Live2DModel.from(modelUrl, { autoInteract: false });
      app.stage.addChild(model);
      positionModel(model);

      model.interactive = true;
      model.buttonMode = true;
      model.on('pointerdown', () => {
        if (waving) return;
        waving = true;
        model.motion('Action', 0);
        setTimeout(async () => {
          app.stage.removeChild(model);
          model.destroy();
          currentModel = await reloadModel();
          waving = false;
        }, 7500);
      });

      return model;
    }

    loadModel().then(model => { currentModel = model; });

    window.addEventListener('resize', () => {
      if (currentModel) positionModel(currentModel);
    });
    document.addEventListener('mousemove', (e) => {
      if (currentModel) currentModel.focus(e.clientX, e.clientY);
    });
  </script>
</body>
</html>
